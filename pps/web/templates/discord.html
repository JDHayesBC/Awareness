{% extends "base.html" %}

{% block title %}Discord - PPS Observatory{% endblock %}

{% block content %}
<div class="bg-gray-800 rounded-lg p-6">
    <div class="mb-6">
        <h1 class="text-2xl font-bold mb-2">Discord Context Windows</h1>
        <p class="text-gray-400">Each block represents a fresh context start with <code class="bg-gray-700 px-1 rounded">ambient_recall("startup")</code>.</p>
        <p class="text-gray-500 text-sm mt-1">When channels sync, Lyra reconstructs identity and memory from PPS layers before responding.</p>
    </div>

    <!-- Filters -->
    <div class="bg-gray-700 rounded-lg p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Time Range</label>
                <select id="hours-filter"
                        class="w-full bg-gray-600 rounded px-3 py-2 text-sm"
                        hx-get="/discord/sessions"
                        hx-trigger="change"
                        hx-target="#discord-list"
                        hx-include="#channel-filter">
                    <option value="24">Last 24 hours</option>
                    <option value="48">Last 48 hours</option>
                    <option value="168">Last 7 days</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Channel</label>
                <select id="channel-filter"
                        class="w-full bg-gray-600 rounded px-3 py-2 text-sm"
                        hx-get="/discord/sessions"
                        hx-trigger="change"
                        hx-target="#discord-list"
                        hx-include="#hours-filter">
                    <option value="">All Channels</option>
                    <option value="general">General</option>
                    <option value="awareness">Awareness</option>
                    <option value="test">Test</option>
                </select>
            </div>
            <div class="flex items-end">
                <button class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm w-full"
                        hx-get="/discord/sessions"
                        hx-target="#discord-list"
                        hx-include="#hours-filter,#channel-filter">
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Discord Sessions List -->
    <div id="discord-list" class="space-y-4">
        {% if sessions %}
            {% for session in sessions %}
            <div class="bg-gray-700 rounded-lg p-4 border-l-4 border-purple-500">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs bg-purple-600 px-2 py-0.5 rounded">Context Window</span>
                            <span class="text-xs text-gray-500">{{ session.session_id[:8] }}</span>
                        </div>
                        <h3 class="font-semibold">{{ session.timestamp }}</h3>
                        <p class="text-sm text-gray-400">
                            Channel: {{ session.channel }} |
                            Triggered by: {{ session.author }}
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-gray-500">Session duration</span>
                        <p class="text-sm text-gray-400">{{ (session.processing_time / 1000)|round(1) }}s</p>
                    </div>
                </div>

                <!-- Wake-up Message -->
                <div class="bg-gray-800 rounded p-3 mb-3">
                    <p class="text-sm font-medium text-purple-300 mb-1">Wake-up Message (first message in this context):</p>
                    <p class="text-sm text-gray-300">{{ session.message_content or '(empty)' }}</p>
                </div>

                <!-- Processing Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm mb-3">
                    <div class="bg-gray-800 rounded px-3 py-2">
                        <p class="text-gray-400 text-xs">Identity Reconstruction</p>
                        <p class="font-semibold">{{ session.identity_load_time }}ms</p>
                    </div>
                    <div class="bg-gray-800 rounded px-3 py-2">
                        <p class="text-gray-400 text-xs">Context Sent to Model</p>
                        <p class="font-semibold">{{ session.context_tokens }} tokens</p>
                    </div>
                    <div class="bg-gray-800 rounded px-3 py-2">
                        <p class="text-gray-400 text-xs">Model Response Time</p>
                        <p class="font-semibold">{{ session.api_time }}ms</p>
                    </div>
                    <div class="bg-gray-800 rounded px-3 py-2">
                        <p class="text-gray-400 text-xs">Response Generated</p>
                        <p class="font-semibold">{{ session.response_tokens }} tokens</p>
                    </div>
                </div>

                <button class="text-blue-400 hover:text-blue-300 text-sm"
                        onclick="toggleTrace('{{ session.session_id }}')">
                    View Processing Timeline â†’
                </button>

                <!-- Expandable Trace Details -->
                <div id="trace-{{ session.session_id }}" class="hidden mt-4">
                    <div class="bg-gray-800 rounded p-4 text-xs text-gray-400">
                        Loading timeline...
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="bg-gray-700 rounded-lg p-8 text-center">
                <p class="text-gray-400">No Discord context windows found in the selected time range.</p>
                <p class="text-sm text-gray-500 mt-2">Context windows appear when the daemon processes messages after identity reconstruction.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Daemon Status -->
<div class="mt-6 bg-gray-800 rounded-lg p-4">
    <h2 class="font-semibold mb-3">Discord Daemon Status</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
        <div>
            <p class="text-gray-400">Status</p>
            <p class="font-semibold {% if daemon_status == 'online' %}status-ok{% else %}status-error{% endif %}">
                {{ daemon_status|default('Unknown') }}
            </p>
        </div>
        <div>
            <p class="text-gray-400">Last Message</p>
            <p class="font-semibold">{{ last_message_time|default('N/A') }}</p>
        </div>
        <div>
            <p class="text-gray-400">Messages Today</p>
            <p class="font-semibold">{{ messages_today|default(0) }}</p>
        </div>
    </div>
</div>

<script>
// Human-readable event type labels
const eventLabels = {
    'session_start': 'ðŸš€ Context window opened',
    'session_complete': 'âœ… Context window closed',
    'identity_reconstruction_start': 'ðŸ”„ Beginning identity reconstruction',
    'identity_reconstruction_complete': 'âœ… Identity reconstructed from PPS',
    'identity_file_read': 'ðŸ“„ Identity file loaded',
    'identity_ambient_recall': 'ðŸ§  ambient_recall("startup") completed',
    'message_received': 'ðŸ“¥ Message received from Discord',
    'message_sent': 'ðŸ“¤ Response sent to Discord',
    'api_call_start': 'ðŸ¤– Sending prompt to Claude',
    'api_call_complete': 'âœ… Claude response received',
    'api_call_error': 'âŒ Claude API error',
    'graphiti_add': 'ðŸ•¸ï¸ Content ingested to knowledge graph',
    'tool_call': 'ðŸ”§ Tool invoked',
    'error': 'âŒ Error occurred',
    'warning': 'âš ï¸ Warning'
};

function formatEventLabel(eventType, data) {
    let label = eventLabels[eventType] || eventType;

    // Add context based on event type and data
    if (eventType === 'api_call_start' && data.model) {
        label = `ðŸ¤– Sending prompt to ${data.model}`;
    }
    if (eventType === 'api_call_complete' && data.model) {
        label = `âœ… Response from ${data.model} (${data.tokens_out || '?'} tokens)`;
    }
    if (eventType === 'graphiti_add' && data.content_preview) {
        const preview = data.content_preview.substring(0, 40);
        const isUser = !preview.toLowerCase().startsWith('lyra');
        label = isUser
            ? 'ðŸ•¸ï¸ User message â†’ knowledge graph'
            : 'ðŸ•¸ï¸ Lyra response â†’ knowledge graph';
    }
    if (eventType === 'message_received' && data.author) {
        label = `ðŸ“¥ Message from ${data.author}`;
    }
    if (eventType === 'message_sent' && data.content_length) {
        label = `ðŸ“¤ Response sent (${data.content_length} chars)`;
    }

    return label;
}

function formatTimestamp(ts) {
    if (!ts) return '';
    // Extract just the time portion
    const match = ts.match(/T(\d{2}:\d{2}:\d{2})/);
    return match ? match[1] : ts.substring(11, 19);
}

function toggleTrace(sessionId) {
    const traceDiv = document.getElementById('trace-' + sessionId);
    if (traceDiv.classList.contains('hidden')) {
        // Fetch detailed trace if not already loaded
        if (!traceDiv.dataset.loaded) {
            fetch('/api/discord/trace/' + sessionId + '/detailed')
                .then(r => r.json())
                .then(data => {
                    let html = '<div class="space-y-1">';

                    data.events.forEach(event => {
                        const time = formatTimestamp(event.timestamp);
                        const label = formatEventLabel(event.event_type, event.data || {});
                        const duration = event.duration_ms ? `<span class="text-gray-500">(${event.duration_ms}ms)</span>` : '';

                        // Check if event has expandable content
                        const hasContent = event.data && (event.data.content_preview || event.data.content_length > 0);
                        const contentId = `content-${sessionId}-${event.id || Math.random().toString(36).substr(2, 9)}`;

                        html += `<div class="py-1.5 border-b border-gray-700 last:border-0">
                            <div class="flex items-start gap-3">
                                <span class="text-gray-500 font-mono w-16 shrink-0">${time}</span>
                                <span class="flex-1">${label} ${duration}</span>
                            </div>`;

                        // Add expandable content preview if available
                        if (event.data && event.data.content_preview) {
                            html += `<div class="ml-20 mt-1 text-gray-500 text-xs italic truncate" title="${event.data.content_preview.replace(/"/g, '&quot;')}">
                                "${event.data.content_preview.substring(0, 80)}${event.data.content_preview.length > 80 ? '...' : ''}"
                            </div>`;
                        }

                        html += '</div>';
                    });

                    html += '</div>';
                    traceDiv.innerHTML = `<div class="bg-gray-800 rounded p-4 text-sm">${html}</div>`;
                    traceDiv.dataset.loaded = 'true';
                })
                .catch(err => {
                    traceDiv.innerHTML = '<div class="bg-gray-800 rounded p-4 text-red-400 text-sm">Failed to load timeline</div>';
                });
        }
        traceDiv.classList.remove('hidden');
    } else {
        traceDiv.classList.add('hidden');
    }
}
</script>
{% endblock %}
